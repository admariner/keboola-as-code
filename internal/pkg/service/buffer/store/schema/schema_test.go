package schema_test

import (
	"context"
	"fmt"
	"testing"
	"time"

	"github.com/stretchr/testify/assert"

	"github.com/keboola/keboola-as-code/internal/pkg/service/buffer/store/key"
	"github.com/keboola/keboola-as-code/internal/pkg/service/buffer/store/schema"
)

type keyTestCase struct{ actual, expected string }

func TestSchema(t *testing.T) {
	t.Parallel()
	s := schema.New(noValidation)

	time1, _ := time.Parse(time.RFC3339, "2006-01-02T15:04:05+07:00")
	time2 := time1.Add(time.Hour)

	projectID := key.ProjectID(123)
	receiverKey := key.ReceiverKey{ProjectID: projectID, ReceiverID: "my-receiver"}
	exportKey := key.ExportKey{ExportID: "my-export", ReceiverKey: receiverKey}
	mappingKey := key.MappingKey{ExportKey: exportKey, RevisionID: 10}
	fileKey := key.FileKey{ExportKey: exportKey, FileID: key.FileID(time1)}
	sliceKey := key.SliceKey{SliceID: key.SliceID(time2), FileKey: fileKey}
	recordKey := key.RecordKey{SliceKey: sliceKey, ReceivedAt: key.ReceivedAt(time2.Add(time.Hour)), RandomSuffix: "abcdef"}
	taskKey := key.TaskKey{ExportKey: exportKey, Type: "some.task", CreatedAt: key.UTCTime(time1), RandomSuffix: "abcdef"}

	cases := []keyTestCase{
		{
			s.Configs().Prefix(),
			"config/",
		},
		{
			s.Configs().Receivers().Prefix(),
			"config/receiver/",
		},
		{
			s.Configs().Receivers().InProject(projectID).Prefix(),
			"config/receiver/00000123/",
		},
		{
			s.Configs().Receivers().ByKey(receiverKey).Key(),
			"config/receiver/00000123/my-receiver",
		},
		{
			s.Configs().Exports().Prefix(),
			"config/export/",
		},
		{
			s.Configs().Exports().InReceiver(receiverKey).Prefix(),
			"config/export/00000123/my-receiver/",
		},
		{
			s.Configs().Exports().ByKey(exportKey).Key(),
			"config/export/00000123/my-receiver/my-export",
		},
		{
			s.Configs().Mappings().Prefix(),
			"config/mapping/revision/",
		},
		{
			s.Configs().Mappings().InReceiver(receiverKey).Prefix(),
			"config/mapping/revision/00000123/my-receiver/",
		},
		{
			s.Configs().Mappings().InExport(exportKey).Prefix(),
			"config/mapping/revision/00000123/my-receiver/my-export/",
		},
		{
			s.Configs().Mappings().ByKey(mappingKey).Key(),
			"config/mapping/revision/00000123/my-receiver/my-export/00000010",
		},
		{
			s.Secrets().Tokens().InReceiver(receiverKey).Prefix(),
			"secret/export/token/00000123/my-receiver/",
		},
		{
			s.Secrets().Tokens().InExport(exportKey).Key(),
			"secret/export/token/00000123/my-receiver/my-export",
		},

		{
			s.Files().Prefix(),
			"file/",
		},
		{
			s.Files().Opened().Prefix(),
			"file/opened/",
		},
		{
			s.Files().Opened().InExport(exportKey).Prefix(),
			"file/opened/00000123/my-receiver/my-export/",
		},
		{
			s.Files().Opened().ByKey(fileKey).Key(),
			"file/opened/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z",
		},
		{
			s.Files().Closing().Prefix(),
			"file/closing/",
		},
		{
			s.Files().Closing().InExport(exportKey).Prefix(),
			"file/closing/00000123/my-receiver/my-export/",
		},
		{
			s.Files().Closing().ByKey(fileKey).Key(),
			"file/closing/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z",
		},
		{
			s.Files().Closed().Prefix(),
			"file/closed/",
		},
		{
			s.Files().Closed().InExport(exportKey).Prefix(),
			"file/closed/00000123/my-receiver/my-export/",
		},
		{
			s.Files().Closed().ByKey(fileKey).Key(),
			"file/closed/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z",
		},
		{
			s.Files().Importing().Prefix(),
			"file/importing/",
		},
		{
			s.Files().Importing().InExport(exportKey).Prefix(),
			"file/importing/00000123/my-receiver/my-export/",
		},
		{
			s.Files().Importing().ByKey(fileKey).Key(),
			"file/importing/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z",
		},
		{
			s.Files().Imported().Prefix(),
			"file/imported/",
		},
		{
			s.Files().Imported().InExport(exportKey).Prefix(),
			"file/imported/00000123/my-receiver/my-export/",
		},
		{
			s.Files().Imported().ByKey(fileKey).Key(),
			"file/imported/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z",
		},
		{
			s.Files().Failed().Prefix(),
			"file/failed/",
		},
		{
			s.Files().Failed().InExport(exportKey).Prefix(),
			"file/failed/00000123/my-receiver/my-export/",
		},
		{
			s.Files().Failed().ByKey(fileKey).Key(),
			"file/failed/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z",
		},
		{
			s.Slices().Prefix(),
			"slice/",
		},
		{
			s.Slices().Opened().Prefix(),
			"slice/opened/",
		},
		{
			s.Slices().Opened().InFile(fileKey).Prefix(),
			"slice/opened/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/",
		},
		{
			s.Slices().Opened().ByKey(sliceKey).Key(),
			"slice/opened/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/2006-01-02T09:04:05.000Z",
		},
		{
			s.Slices().Closing().InFile(fileKey).Prefix(),
			"slice/closing/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/",
		},
		{
			s.Slices().Closing().ByKey(sliceKey).Key(),
			"slice/closing/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/2006-01-02T09:04:05.000Z",
		},
		{
			s.Slices().Uploading().InFile(fileKey).Prefix(),
			"slice/uploading/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/",
		},
		{
			s.Slices().Uploading().ByKey(sliceKey).Key(),
			"slice/uploading/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/2006-01-02T09:04:05.000Z",
		},
		{
			s.Slices().Uploaded().InFile(fileKey).Prefix(),
			"slice/uploaded/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/",
		},
		{
			s.Slices().Uploaded().ByKey(sliceKey).Key(),
			"slice/uploaded/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/2006-01-02T09:04:05.000Z",
		},
		{
			s.Slices().Failed().InFile(fileKey).Prefix(),
			"slice/failed/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/",
		},
		{
			s.Slices().Failed().ByKey(sliceKey).Key(),
			"slice/failed/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/2006-01-02T09:04:05.000Z",
		},
		{
			s.Records().Prefix(),
			"record/",
		},
		{
			s.Records().ByKey(recordKey).Key(),
			"record/00000123/my-receiver/my-export/2006-01-02T09:04:05.000Z/2006-01-02T10:04:05.000Z_abcdef",
		},
		{
			s.Secrets().Tokens().InExport(exportKey).Key(),
			"secret/export/token/00000123/my-receiver/my-export",
		},
		{
			s.Runtime().Prefix(),
			"runtime/",
		},
		{
			s.Runtime().WorkerNodes().Prefix(),
			"runtime/worker/node/",
		},
		{
			s.Runtime().WorkerNodes().Active().Prefix(),
			"runtime/worker/node/active/",
		},
		{
			s.Runtime().WorkerNodes().Active().IDs().Prefix(),
			"runtime/worker/node/active/id/",
		},
		{
			s.Runtime().WorkerNodes().Active().IDs().Node("my-node").Key(),
			"runtime/worker/node/active/id/my-node",
		},
		{
			s.Runtime().APINodes().Prefix(),
			"runtime/api/node/",
		},
		{
			s.Runtime().APINodes().Watchers().Prefix(),
			"runtime/api/node/watcher/",
		},
		{
			s.Runtime().APINodes().Watchers().Revision().Prefix(),
			"runtime/api/node/watcher/cached/revision/",
		},
		{
			s.Runtime().APINodes().Watchers().Revision().Node("my-node").Key(),
			"runtime/api/node/watcher/cached/revision/my-node",
		},
		{
			s.Runtime().Lock().Prefix(),
			"runtime/lock/",
		},
		{
			s.Runtime().Lock().Task().Prefix(),
			"runtime/lock/task/",
		},
		{
			s.Runtime().Lock().Task().InExport(exportKey).Prefix(),
			"runtime/lock/task/00000123/my-receiver/my-export/",
		},
		{
			s.Runtime().Lock().Task().InExport(exportKey).Key("my-lock").Key(),
			"runtime/lock/task/00000123/my-receiver/my-export/my-lock",
		},
		{
			s.Tasks().Prefix(),
			"task/",
		},
		{
			s.Tasks().ByProject(projectID).Prefix(),
			"task/00000123/",
		},
		{
			s.Tasks().ByReceiver(receiverKey).Prefix(),
			"task/00000123/my-receiver/",
		},
		{
			s.Tasks().ByExport(exportKey).Prefix(),
			"task/00000123/my-receiver/my-export/",
		},
		{
			s.Tasks().ByKey(taskKey).Key(),
			"task/00000123/my-receiver/my-export/some.task/2006-01-02T08:04:05.000Z_abcdef",
		},
		{
			s.ReceivedStats().InReceiver(receiverKey).Prefix(),
			"stats/received/00000123/my-receiver/",
		},
		{
			s.ReceivedStats().InExport(exportKey).Prefix(),
			"stats/received/00000123/my-receiver/my-export/",
		},
		{
			s.ReceivedStats().InFile(fileKey).Prefix(),
			"stats/received/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/",
		},
		{
			s.ReceivedStats().InSlice(sliceKey).Prefix(),
			"stats/received/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/2006-01-02T09:04:05.000Z/",
		},
		{
			s.ReceivedStats().InSlice(sliceKey).ByNodeID("my-node").Key(),
			"stats/received/00000123/my-receiver/my-export/2006-01-02T08:04:05.000Z/2006-01-02T09:04:05.000Z/my-node",
		},
	}

	for i, c := range cases {
		assert.Equal(t, c.expected, c.actual, fmt.Sprintf(`case "%d"`, i+1))
	}
}

func noValidation(_ context.Context, _ any) error {
	return nil
}
